{{PAGETITLE="Master Merchant"}}
== Contents
{{CONTENTS=3}}
== Authors

Philgo68, Khaibit, dOpiate, sirinsidiator, Garkin, Sharlikran

== Version History

Apparently for version 2.2.0 there was an experimental turbo mode added to MM. From the change log it appears that this was removed by request from Zenimax. However, even I noticed when you tried to download 2.2.1 which had turbo mode removed, you received a file named <font class="purple">Master Merchant 2.2.0.zip</font>. If you tried to engage turbo mode it was still available even if it didn't work as expected.

Aug 01 2020 after the kiosk flip was announced Philgo68 posted that he would be uploading a new version, which would be 2.3.1. From the start it had a small bug in it that prevented it from working. Then after that was fixed people started reporting that the Master Merchant window would not update when you were viewing your personal sales but that all guild sales was still updating properly.

Upon examination of the code 2.3.1 had turbo mode removed which was not really removed in 2.2.1 (2.2.0). In addition to that on the description page it was mentioned that there was Simple Indexing and Simple Scanning. Oddly those options included new options in the Addons menu to toggle the features on and off. These options were not present in 2.2.1.

This makes me believe that 2.3.1 was really intended to be the proposed 2.2.1 but somehow the upload never went through properly. I am glad Philgo68 uploaded the version as it has helped me understand the code a bit more.

== Background Scanning Depreciated

As of version 3.0.0 there is no <code>/mm missing</code> and no background scan. The background scan would get hung up by repeated attempts to request more sales data from the server. When the server denied the request MM would continue to wait for the request to be approved. While in reality if there were 100, 1000, or more sales events in the guild history MM would not attempt to scan them until it simply gave up and stopped scanning altogether. However, at that point you might have received a notification of no new sales.

After starting a new library [[https://github.com/ESOUIMods/LibGuildHistoryCache | LibGuildHistoryCache]] I observed that the cache mod would see some new sales. Usually there were only a few sales maybe 1 or 2 and occasionally less then 10. The cache mod would update showing that the guild history events were not duplicates but MM would not see them as new sales. This is why MM no longer uses a background scan as it attempted to scan from a specific point in time and loop over the guild history events. 

One other calculation made was to try and get the first entry in the guild history and the last. This was used to attempt to determine whether or not to scan from the start of the list or the end. Whether or not you have 1, 100, or more then 1000 events the first event will always be the same. All guild history events are appended onto the end of the list.

== Monitoring Incoming Guild History

With version 3.0.0 any guild history update is examined and then MM will look for new sales and ignore the duplicates. All new sales coming in will be updated automatically as the server adds them to the guild history. However, to obtain older sales data for any time you have been offline you will need to manually scan the guild history from the guild history tab by [[#Select A Guild | pressing E for Show More]]. Not because anything has changed but because the server will deny the repeated automatic requests.

To know when you no longer need more guild history you need to temporarily set the verbose level to 5 using <code>/mm verbose 5</code>. As you request more older sales data eventually you will catch up to where you were when you last logged out. At that point MM will notify you that it found no new sales.

{{image:eventmonitor_notifications.jpg | eventmonitor_notifications}}

I belong to three casual trading guilds. For the first you see in the Green box that there were about 106 new sales for the short amount of time I was offline. The second with the blue box only 3 new sales. The last is much busier even for a casual guild and for a few hours of sales 463 sales. You will know you are caught up when MM says it found no new sales.

{{note:This will only work as intended if you have done a 10 day scan for all the guilds you belong to after updating to 3.0.0. Otherwise there could be gaps in guild history you have not recorded in your MM database.}}

After you are finished set the verbose level to 4 or lower. For the least amount of notifications but so you still receive any important information <code>/mm verbose 2</code> is a good option.

== What is being scanned

When MM is telling you that it is scanning it is obtaining the number of sales in your guild history that you have loaded into memory and obtaining the data from the game for each entry.

### A few days of sales from 109 entries

{{image:shot_history.jpg | shot_history}}

MM and other guild related tools simply scan entries from the guild history. With another mod installed called <font class="purple">Shissu's Guild Tools</font> a count of the amount of entries is showing. As shown there are 109 entries which only covers a few minutes of sales.

### 4 days of sales from 8031 entries

{{image:long_list.jpg | shot_history}}

However, as shown in the above screen shot there are 8031 entries which covers 4 days of sales. If you feel you are missing sales from 7 days ago then you will need more sales showing on the guild history tab.

{{note:A specific range of sales can not be requested at this time and the ability to do so might not become available until 2021 as shown in this [[#New API 2021 | response from ZOS]].}}

== Manually updating Guild History

From what I can tell people feel that there is a cache or the server sends guild history to the user like a streaming video service. This is not the case. If you have 100 sales showing that covers a few minutes of sales, if you have 8000 sales that might cover 4 days of sales, or if you have 800 sales that covers 10 days of sales it doesn't matter. What you have loaded into memory is what is going to be scanned.

### When you first log in

{{image:no_sales_history.jpg | no_sales_history}}

When you first log in there might be 0 sales in your guild history until you open the guild history. As shown in the above screen shot with some extra debug messages this was the case when I first logged in. What some previous versions would show upon logging in was "no new sales". It would probably have been more informative to update the message as I have shown.

### Select A Guild

{{image:show_more.jpg | show_more}}

In order to manually request more sales data you have to choose a guild and select All, not purchases. Then press E about every 3 seconds.

{{note:Pressing E more frequently is pointless and the server can impose more restrictions as it sees fit as mentioned [[#It takes too long to scan | here]].}}

### When E is no longer showing

{{image:10_days_sales.jpg | show_more}}

Once you have scanned 10 days of sales then the option to press E will not be shown. This guild is more casual and if you are in a busy guild you may have to press E until you have 16,000 to 20,000 sales listed in the guild history.

{{note:Scanning 10 days of history every few days or every week is pointless and a drain on the server. Once you scan 10 days of data you only need to scan sales for the time you have been offline. If you have been offline less the 24 hours then request 1 day of sales and use <font class="purple">/mm missing</font> to scan the data.}}

== Myths

=== Displaying a percentage of time

{{image:certain_amount_history.jpg | certain_amount_history}}

[[bb:Quote]]
Would it be possible to add back the scan % messages back to the verbose modes?
[[be:]]
 It has not been removed. It only happens during the background scan.
[[bb:Quote]]
The method I used in the past for loading sales data for the period between my last login and my current login was to set verbosity to 4 so I could see the % of each guild scan. I would then run through each guild history sales (by pressing E) until MM showed 100% for that guild (I am never offline for more than 3 days so I always had full data). Once it hit 100% for a guild I would do the next guild. The entire process took less than a minute (despite being in several major trade guilds) and it always gave me full data each day. 
[[be:]]
The current message is not any indication that there is a certain amount of time being scanned.

=== It takes too long to scan

{{image:every_three_seconds.jpg | every_three_seconds}}

You can not request data faster.

=== New API 2021

{{image:new_api_2021.jpg | new_api_2021}}

[[bb:Quote]]
The method I used in the past for loading sales data for the period between my last login and my current login was to set verbosity to 4 so I could see the % of each guild scan. I would then run through each guild history sales (by pressing E) until MM showed 100% for that guild (I am never offline for more than 3 days so I always had full data). Once it hit 100% for a guild I would do the next guild. The entire process took less than a minute (despite being in several major trade guilds) and it always gave me full data each day. 
[[be:]]

There has never been any way to scan a range of data. You get the initial 100 most recent sales, and then you can request more older sales. To do so press E on the guild history tab.

=== older data unchanged

{{image:older_data-unchanged.jpg | older_data-unchanged}}

[[bb:Quote]]
I can scan days of history once a week.
[[be:]]

There is no point in doing this as you have already seen the data unless you didn't log in enough to keep your data up to date.

=== older in time

{{image:older_in_time.jpg | older_in_time}}

The server gives you older data when you request it by pressing E on the guild history tab. New sales are received when the server provides them. 

=== Reload UI

{{image:reloading.jpg | reloading}}

Reloading the UI does not reset the history.

=== Streaming Data

{{image:steaming_data.jpg | steaming_data}}

[[bb:Quote]]
It worked fine this morning, but when I log in now, it tells me for 4 of my 5 guilds "Guild XY has no sales" (verbose 4) even though they are all trading guilds. Is there way to fix this? There should be several hundred new sales to scan.
[[be:]]
[[bb:Quote]]
I have no idea how else am I supposed to get any sales when MM got to about five hours worth of history in several hours of the game sitting idle. 
[[be:]]
MM can not request data like a streaming video server. If you do not have several hundred sales to scan in your guild history then you will not see the updates you expect.
