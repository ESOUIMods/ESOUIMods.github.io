{{PAGETITLE="Master Merchant"}}
== Contents
{{CONTENTS=3}}
== Authors

Philgo68, Khaibit, dOpiate, sirinsidiator, Garkin, Aldanga, Sharlikran, Dolgubon

== Version History

Apparently for version 2.2.0 there was an experimental turbo mode added to MM. From the change log it appears that this was removed by request from Zenimax. However, even I noticed when you tried to download 2.2.1 which had turbo mode removed, you received a file named <font class="purple">Master Merchant 2.2.0.zip</font>. If you tried to engage turbo mode it was still available even if it didn't work as expected.

Aug 01 2020 after the kiosk flip was announced Philgo68 posted that he would be uploading a new version, which would be 2.3.1. From the start it had a small bug in it that prevented it from working. Then after that was fixed people started reporting that the Master Merchant window would not update when you were viewing your personal sales but that all guild sales was still updating properly.

Upon examination of the code 2.3.1 had turbo mode removed which was not really removed in 2.2.1 (2.2.0). In addition to that on the description page it was mentioned that there was Simple Indexing and Simple Scanning. Oddly those options included new options in the Addons menu to toggle the features on and off. These options were not present in 2.2.1.

This makes me believe that 2.3.1 was really intended to be the proposed 2.2.1 but somehow the upload never went through properly. I am glad Philgo68 uploaded the version as it has helped me understand the code a bit more.

== Background Scanning Depreciated

As of version 3.0.0 there is no <code>/mm missing</code> and no background scan. The background scan would get hung up by repeated attempts to request more sales data from the server. When the server denied the request MM would continue to wait for the request to be approved.

After starting a new library [[https://github.com/ESOUIMods/LibGuildHistoryCache | LibGuildHistoryCache]] I observed that the cache mod would see some new sales. Usually there were only a few sales maybe 1 or 2 and occasionally less then 10. The cache mod would update showing that the guild history events were not duplicates but MM would not see them as new sales. 

One other calculation made was to try and get the first entry in the guild history and the last. This was used to attempt to determine whether or not to scan from the start of the guild history array, or the end. Whether or not you have 1, 100, or more then 1000 events the first event will always be the same. All guild history events are appended onto the end of the list.

For reasons like these MM no longer uses a background scan as it attempted to scan from a specific point in time and loop over the guild history events.

== Three states of LibHistoire cache

### Unlinked

{{image:red_text_unlinked.jpg | red_text_unlinked}}

In the Unlinked state you can either wait for the server to grant the requests for offline data that LibHistoire requests, or you can manually request guild history for the time you were offline.

### Linking in progress

{{image:yellow_text_linking.jpg | yellow_text_linking}}

Once LibHistoire has what it feels it needs, then it will begin processing the guild history events and attempt to link to the last known event.

### Linked

{{image:green_text_linked.jpg | green_text_linked}}

Once LibHistoire has linked to its stored events you should see green text. This means that LibHistoire has finished processing the guild history.

{{note: You can still request additional history and ask LibHistoire to check the guild history for any missing sales events using the rescan button.}}

== Ten Day Scan

After upgrading to 3.x you will need to do a Ten Day Scan of all the guilds you are in. This ensures that LibHistoire has stored sales data for you to start working with. After doing a ten day scan for each guild you only need to request guild history for the time you have been offline.

{{note: Initially I had suggested requesting all the data at once. This seems to cause an issue for some users. Read this section carefully.}}

### Select A Guild

When you first log in there wonâ€™t be much as far as guild history loaded in memory.

{{image:show_more.jpg | show_more}}

In order to manually request sales data you have to choose a guild and select All, not purchases. Then press E about every 3 seconds so you are not kicked from the game by the server.

### Request only a few days at a time

{{image:one_day_of_data.jpg | one_day_of_data}}

You should be able to request 2 or three days of guild history at once. However, some users have seen issues requesting too much at one time. Each time you request a few days of data stop and, click the Rescan button.

### Rescan button

{{image:ten_day_scan_refresh.jpg | ten_day_scan_refresh}}

The Rescan button is the equivalent of the old <code>/mm missing</code> and it will scan all the data loaded into memory so far. LibHistorie will skip any duplicate events as it scans guild history.

### When E is no longer showing

{{image:10_days_sales.jpg | show_more}}

Once you have scanned 10 days of sales then the option to press E will not be shown. The server will only allow you to request 10 days of data. Once you have done so click the [[#Rescanbutton|Rescan Button]] to make sure LibHistorie processes all the events.

### LibHistoire GUI

{{image:histy_gui.jpg | histy_gui}}

As you perform a ten day scan the LibHistoire GUI will update. It might even finish processing a certain amount of events. Do not click the small chain link showing in this screen shot. That will link to the current events loaded which for your first initial use of LibHistorie you do not want that to happen. You should only click the [[#Rescanbutton|Rescan Button]] if you see it to ensure all events are scanned.

{{note:Scanning 10 days of history every few days or every week is pointless and a drain on the server.}}

== Update Your Guild History Each Day

{{image:histy_gui.jpg | histy_gui}}

Regardless of how long you have been offline you need to update your guild history. To obtain older sales data for any time you have been offline you can wait for the server to send the data to LibHistoire. How quickly the server provides the data depends on many things. Because of that I do not wait. I manually scan the guild history from the guild history tab by [[#Select A Guild | pressing E for Show More]].

After I have enough guild history to cover the time I have been offline then I use the rescan button which asks LibHistoire to double check the sales loaded in memory are in the cache. Once LibHistoire has verified the sales data the text will turn green indicating that the [[#Linked | sales events are linked]].

== Refresh Button

{{image:refresh_button.jpg | refresh_button}}

The Refresh button tells LibHistorie to send all the data it has in its cache. The more data in the cache, the longer it will take to transmit.

The refresh button is only a fail safe mechanisum in case a user performs the initial Ten Day scan incorrectly and the data is not sent to MM for some reason. It should not be clicked every so often or every once and a while. Clicking this does not refresh the Master Merchant window or cause the server to send any Guild History.

== Erroneous timestamp

When you see an erroneous timestamp, LibHistoire will handle this internally. It will not be processed until the timestamp is updated properly by the server.

{{image:1657months.jpg | 1657months}}
{{image:71582789minutes.jpg | 71582789minutes}}

LibHistoire will send the sale to MM after it checks that the erroneous timestamp is no longer present.

== What is being scanned

When LibHistoire is scanning the guild history it is obtaining the sales from all the guild history that you have loaded into memory.

### A few days of sales from 109 entries

{{image:shot_history.jpg | shot_history}}

LibHistoire simply scan entries from the guild history. With another mod installed called <font class="purple">Shissu's Guild Tools</font> a count of the amount of entries is showing. As shown there are 109 entries which only covers a few minutes of sales.

### 4 days of sales from 8031 entries

{{image:long_list.jpg | shot_history}}

However, as shown in the above screen shot there are 8031 entries which covers 4 days of sales. If you feel you are missing sales from 7 days ago then you will need more sales showing on the guild history tab.

== Sales Week

As of  August 11 2020 the kiosk flip is now [[ https://forums.elderscrollsonline.com/en/discussion/540142/updates-to-guild-trader-swap-times/p1 | every Tuesday]]. All sales totals are calculated from the time indicated by ZOS.

You should not try to calculate your sales yourself. Each sale is saved with the exact time stamp the sale occurred. All sales even a few seconds prior to the kiosk flip would not show if you selected to see sales from This Week.

{{note:On the day of the kiosk flip sales for This Week will only reset after Zenimax transmits the new kiosk flip time. This can occur several hours after the kiosk flip.}}

== Locating LibExecutionQueue

LibExecutionQueue is included with Master Merchant as shown in the zip below.

{{image:leq_included.jpg | leq_included}}

LibExecutionQueue is sorted alphabetically by the base game.

{{image:leq_unsorted.jpg | leq_unsorted}}

If you have LibVotansAddonList installed then it will look close to the base game.

{{image:leq_votans_sort.jpg | leq_votans_sort}}

== Backup Master Merchant Data

{{image:mm_data_backup.jpg | mm_data_backup}}

To backup your Master Merchant data you will need to navigate to the SavedVariables folder. Usually <code>C:\Users\Your User Name\Documents\Elder Scrolls Online\live</code>. The files can be easily found going to MyDocuments in windows first. 

{{note: I am sorry I don't know where it is located on a Mac.}}

Once you are in the SavedVariables folders, you will need to copy the 16 MMxxData files named MM00Data.kua to MM15Data.lua as shown in the screen shot. Copy these to a separate folder outside of SavedVariables and do not place them in a subfolder under SavedVariables.

== Export Sales Report

{{image:mm_export_screen.jpg | mm_export_screen}}

Master Merchant can export a general summary of sales for use with spreadsheets. Full disclosure I am not a spreadsheet guru so I can not help with this feature. To use the export feature choose a guild to work with, then select the time and range like This Week or Last Week. Then use <code>/mm export #</code> to export the guild's information. As an example the screen shot shows a 2 for the 2nd guild in your list, therefore the syntax would be <code>/mm export 2</code>.

Once exported the data is saved in <code>MasterMerchant.lua</code> in your <code>SavedVariables</code> folder.

<font class="cyan">Without Taxes:</font>
<pre>
["EXPORT"] = 
{
    ["version"] = 1,
    ["YourGuildName"] = 
    {
        [1] = "@GuildMember&Sales&Purchaces&Rank",
    },
</pre>

<font class="cyan">With Taxes:</font>
<pre>
["EXPORT"] = 
{
    ["version"] = 1,
    ["YourGuildName"] = 
    {
        [1] = "@GuildMember&Sales&Purchaces&Taxes&Rank",
    },
</pre>

{{note: Taxes is new as of 3.2.7 and you toggle the feature on in addon settings.}}

Since I have never used this feature with a spreadsheet I do not know how easy that is to use as Lua saves it. You may need to copy and paste it into another text file and use regular expressions to clean that up.

{{note: Some of my GMs have explained if this format changed it would break what they currently use so it will not be altered.}}
